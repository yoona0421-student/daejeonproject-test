// main.js
// Ï∂îÌõÑ ÏßÄÎèÑ, ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ, Ï†úÎ≥¥ Í∏∞Îä• Îì± JS Ï∂îÍ∞Ä ÏòàÏ†ï

// Í≤åÏãúÍ∏Ä Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
async function fetchPosts() {
  const res = await fetch('http://localhost:4000/api/posts');
  const posts = await res.json();
  const list = document.getElementById('posts-list');
  list.innerHTML = '';
  posts.forEach(post => {
    const li = document.createElement('li');
    li.innerHTML = `<span class="post-title">${post.title}</span>
      <span class="post-date">${new Date(post.created_at).toLocaleString()}</span>
      <div class="post-content">${post.content}</div>`;
    list.appendChild(li);
  });
}

// Í≤åÏãúÍ∏Ä ÏûëÏÑ± ÌèºÏù¥ ÏóÜÎäî Í≤ΩÏö∞ Ïò§Î•ò Î∞©ÏßÄ (ÏûêÎèô Ï£ºÏÑù Ï≤òÎ¶¨)
// document.getElementById('post-form')Í∞Ä ÏóÜÏúºÎ©¥ ÏïÑÎûò ÏΩîÎìú Ïã§Ìñâ ÏïàÌï®
// if (document.getElementById('post-form')) {
//   document.getElementById('post-form').addEventListener('submit', async function(e) {

// Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Î†àÏù¥Ïñ¥ Ìï≠Î™© Î∂ÑÎ•ò
const layerCategories = [
  {
    name: 'ÏÇ¨Í≥† Ï†ê',
    items: [
      'ÏÇ¨Í≥† Ï†ê(Ï†ÑÏ≤¥: ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÌÅ¥Îü¨Ïä§ÌÑ∞(ÏúÑÌóòÎèÑ, ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)'
    ]
  },
  {
    name: 'Î≤ïÍ∑úÏúÑÎ∞ò',
    items: [
      'Î≤ïÍ∑úÏúÑÎ∞ò ¬∑ ÏïàÏ†ÑÏö¥Ï†ÑÎ∂àÏù¥Ìñâ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò ¬∑ Î≥¥ÌñâÏûêÎ≥¥Ìò∏ÏùòÎ¨¥ÏúÑÎ∞ò (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò ¬∑ Ïã†Ìò∏ÏúÑÎ∞ò (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò ¬∑ Í∏∞ÌÉÄ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò ¬∑ Ï§ëÏïôÏÑ†Ïπ®Î≤î (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò ¬∑ ÏïàÏ†ÑÍ±∞Î¶¨ÎØ∏ÌôïÎ≥¥ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò ¬∑ ÍµêÏ∞®Î°úÏö¥ÌñâÎ∞©Î≤ïÏúÑÎ∞ò (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)'
    ]
  },
  {
    name: 'ÎÖ∏Î©¥ÏÉÅÌÉú',
    items: [
      'ÎÖ∏Î©¥ÏÉÅÌÉú ¬∑ Í±¥Ï°∞ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎÖ∏Î©¥ÏÉÅÌÉú ¬∑ Ï†ñÏùå/ÏäµÍ∏∞ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎÖ∏Î©¥ÏÉÅÌÉú ¬∑ ÏäµÍ∏∞ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎÖ∏Î©¥ÏÉÅÌÉú ¬∑ ÏÑúÎ¶¨/Í≤∞Îπô (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)'
    ]
  },
  {
    name: 'Í∏∞ÏÉÅÏÉÅÌÉú',
    items: [
      'Í∏∞ÏÉÅÏÉÅÌÉú ¬∑ ÎßëÏùå (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Í∏∞ÏÉÅÏÉÅÌÉú ¬∑ ÎπÑ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Í∏∞ÏÉÅÏÉÅÌÉú ¬∑ ÌùêÎ¶º (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)'
    ]
  },
  {
    name: 'ÎèÑÎ°úÌòïÌÉú',
    items: [
      'ÎèÑÎ°úÌòïÌÉú ¬∑ Îã®ÏùºÎ°ú - Í∏∞ÌÉÄ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎèÑÎ°úÌòïÌÉú ¬∑ ÍµêÏ∞®Î°ú - ÍµêÏ∞®Î°úÌö°Îã®Î≥¥ÎèÑÎÇ¥ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎèÑÎ°úÌòïÌÉú ¬∑ ÍµêÏ∞®Î°ú - ÍµêÏ∞®Î°úÏïà (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎèÑÎ°úÌòïÌÉú ¬∑ ÍµêÏ∞®Î°ú - ÍµêÏ∞®Î°úÎ∂ÄÍ∑º (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎèÑÎ°úÌòïÌÉú ¬∑ Í∏∞ÌÉÄ - Í∏∞ÌÉÄ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎèÑÎ°úÌòïÌÉú ¬∑ Îã®ÏùºÎ°ú - Ìö°Îã®Î≥¥ÎèÑÏÉÅ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎèÑÎ°úÌòïÌÉú ¬∑ Îã®ÏùºÎ°ú - Ìö°Îã®Î≥¥ÎèÑÎ∂ÄÍ∑º (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎèÑÎ°úÌòïÌÉú ¬∑ Îã®ÏùºÎ°ú - Í≥†Í∞ÄÎèÑÎ°úÏúÑ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎèÑÎ°úÌòïÌÉú ¬∑ Ï£ºÏ∞®Ïû• - Ï£ºÏ∞®Ïû• (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'ÎèÑÎ°úÌòïÌÉú ¬∑ Îã®ÏùºÎ°ú - ÏßÄÌïòÏ∞®ÎèÑ(ÎèÑÎ°ú)ÎÇ¥ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)'
    ]
  },
  {
    name: 'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú',
    items: [
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß ÏïàÏ†ÑÏö¥Ï†ÑÎ∂àÏù¥Ìñâ ¬∑ ÎßëÏùå (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß Î≥¥ÌñâÏûêÎ≥¥Ìò∏ÏùòÎ¨¥ÏúÑÎ∞ò ¬∑ ÎßëÏùå (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß Ïã†Ìò∏ÏúÑÎ∞ò ¬∑ ÎßëÏùå (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß Í∏∞ÌÉÄ ¬∑ ÎßëÏùå (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß ÏïàÏ†ÑÏö¥Ï†ÑÎ∂àÏù¥Ìñâ ¬∑ ÎπÑ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß ÏïàÏ†ÑÏö¥Ï†ÑÎ∂àÏù¥Ìñâ ¬∑ ÌùêÎ¶º (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß Î≥¥ÌñâÏûêÎ≥¥Ìò∏ÏùòÎ¨¥ÏúÑÎ∞ò ¬∑ ÎπÑ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß Ï§ëÏïôÏÑ†Ïπ®Î≤î ¬∑ ÎßëÏùå (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß ÏïàÏ†ÑÍ±∞Î¶¨ÎØ∏ÌôïÎ≥¥ ¬∑ ÎßëÏùå (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß Ïã†Ìò∏ÏúÑÎ∞ò ¬∑ ÌùêÎ¶º (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß Î≥¥ÌñâÏûêÎ≥¥Ìò∏ÏùòÎ¨¥ÏúÑÎ∞ò ¬∑ ÌùêÎ¶º (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß ÍµêÏ∞®Î°úÏö¥ÌñâÎ∞©Î≤ïÏúÑÎ∞ò ¬∑ ÎßëÏùå (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß Ïã†Ìò∏ÏúÑÎ∞ò ¬∑ ÎπÑ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß Í∏∞ÌÉÄ ¬∑ ÎπÑ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß ÏïàÏ†ÑÍ±∞Î¶¨ÎØ∏ÌôïÎ≥¥ ¬∑ ÌùêÎ¶º (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)',
      'Î≤ïÍ∑úÏúÑÎ∞ò‚àßÍ∏∞ÏÉÅÏÉÅÌÉú ‚àß Ï§ëÏïôÏÑ†Ïπ®Î≤î ¬∑ ÎπÑ (ÎπÑÎ≥¥Ìò∏Íµ¨Ïó≠)'
    ]
  },
  {
    name: 'Í∏∞ÌÉÄ',
    items: [
      'ÌïôÍµê¬∑Ïú†ÏπòÏõê(Î≥¥Ï°∞CSV Ï†ÑÏ≤¥)'
    ]
  }
];

// Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ï≤¥ÌÅ¨Î∞ïÏä§ UI ÏÉùÏÑ±
function renderLayerCheckboxes() {
  const box = document.getElementById('layer-checkbox-list');
  let html = '';
  let layerIdx = 0;
  layerCategories.forEach((cat, catIdx) => {
    html += `<div class="layer-category">
      <div class="category-header" style="display:flex; align-items:center; justify-content:space-between; font-weight:600; font-size:1.08em; margin-bottom:6px;">
        <span>${cat.name}</span>
        <button class="toggle-btn" data-cat="${catIdx}" style="background:#ffe066; border:none; border-radius:8px; padding:2px 12px; font-size:0.98em; cursor:pointer;">ÎçîÎ≥¥Í∏∞</button>
      </div>
      <div class="category-items" data-cat="${catIdx}" style="display:none; flex-direction:column; gap:6px;">
        ${cat.items.map(item => `
          <label style="display:flex; align-items:center; gap:6px; font-size:1em; background:#fff; border-radius:8px; padding:6px 12px; box-shadow:0 1px 4px rgba(0,0,0,0.04);">
            <input type="checkbox" class="layer-checkbox" data-layer="layer${layerIdx++}" checked>
            <span>${item}</span>
          </label>
        `).join('')}
      </div>
    </div>`;
  });
  box.innerHTML = html;
}

// ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº ÌÜ†Í∏Ä Í∏∞Îä•
function setupCategoryToggle() {
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const catIdx = this.getAttribute('data-cat');
      const items = document.querySelector(`.category-items[data-cat="${catIdx}"]`);
      if (items.style.display === 'none') {
        items.style.display = 'flex';
        this.textContent = 'Îã´Í∏∞';
      } else {
        items.style.display = 'none';
        this.textContent = 'ÎçîÎ≥¥Í∏∞';
      }
    });
  });
}

// Folium ÏßÄÎèÑ iframe ÎÇ¥ Î†àÏù¥Ïñ¥ Ï†úÏñ¥ JS (postMessage ÌôúÏö©)
function setupLayerControl() {
  const checkboxes = document.querySelectorAll('.layer-checkbox');
  checkboxes.forEach(cb => {
    cb.addEventListener('change', function() {
      const layerId = this.getAttribute('data-layer');
      const checked = this.checked;
      // Folium ÏßÄÎèÑ iframeÏóê Î©îÏãúÏßÄ Ï†ÑÎã¨
      const iframe = document.getElementById('daejeon-map');
      iframe.contentWindow.postMessage({ type: 'layer-control', layerId, checked }, '*');
    });
  });
}

// DOMContentLoaded Ïãú Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉùÏÑ± Î∞è Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞

document.addEventListener('DOMContentLoaded', function() {
  renderLayerCheckboxes();
  setupCategoryToggle();
  setTimeout(setupLayerControl, 500); // iframe Î°úÎî© ÌõÑ Ïó∞Í≤∞
});

// ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ÏòàÏãú (ÎßåÏïΩ ÏßÅÏ†ë JSÏóêÏÑú Leaflet ÏßÄÎèÑÎ•º ÏÉùÏÑ±ÌïúÎã§Î©¥ ÏïÑÎûòÏ≤òÎüº Î≥ÑÎèÑ Ìï®ÏàòÎ°ú Î∂ÑÎ¶¨)
// function initMap() {
//   const map = L.map('daejeon-map', {
//     center: [36.3504119, 127.3845475],
//     zoom: 12,
//     zoomControl: false,
//     attributionControl: false
//   });
//   L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
//     opacity: 0.7
//   }).addTo(map);
//
//   // ÏòàÏãú Îç∞Ïù¥ÌÑ∞ (Ïú†ÏπòÏõê/Ï¥àÎì±ÌïôÍµê ÏúÑÏπò ÏùºÎ∂Ä)
//   const data = [ ... ];
//   // ÌÅ¥Îü¨Ïä§ÌÑ∞ Í∑∏Î£π ÏÉùÏÑ± Î∞è ÎßàÏª§ Ï∂îÍ∞Ä Îì±...
// }

  // Ïã§ÏãúÍ∞Ñ Îâ¥Ïä§ ÏïåÎ¶º (ÎÑ§Ïù¥Î≤Ñ RSS)
  async function fetchNews() {
    // ÎÑ§Ïù¥Î≤Ñ Îâ¥Ïä§ RSS (ÎåÄÏ†Ñ keyword)
    const rssUrl = 'https://news.google.com/rss/search?q=%EB%8C%80%EC%A0%84+%EC%95%88%EC%A0%84+%EC%86%8C%EC%8B%9D&hl=ko&gl=KR&ceid=KR:ko';
    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(rssUrl);
    try {
      const res = await fetch(proxyUrl);
      // ...Îâ¥Ïä§ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ ÏΩîÎìú...
    } catch (err) {
      console.error('Îâ¥Ïä§ Îç∞Ïù¥ÌÑ∞ fetch Ï§ë Ïò§Î•ò:', err);
    }
  }

// Í≤åÏãúÍ∏Ä Î†åÎçîÎßÅ Ìï®Ïàò ÏòàÏãú (ÌÖúÌîåÎ¶ø Î¶¨ÌÑ∞Îü¥ Ïò§Î•ò ÏàòÏ†ï)
function renderPosts(posts, districtSelect, postsContainer) {
  posts.forEach(post => {
    const postDiv = document.createElement('div');
    postDiv.className = 'post';
    postDiv.innerHTML = `
      ${post.imageData ? `<img src="${post.imageData}" alt="Ï≤®Î∂Ä Ïù¥ÎØ∏ÏßÄ">` : ''}
      <div class="meta">
        <span class="type">${post.reportType || ''}</span>
        <span class="district">${post.district}</span>
        <span class="date">${post.date ? post.date : ''}</span>
      </div>
      <div class="content">${post.content}</div>
      <div>Ï¢ãÏïÑÏöî: <span class="like-count">${post.likes}</span> <button class="like-btn">üëç</button></div>
      <div>
        <b>ÎåìÍ∏Ä</b>
        <ul class="comments">
          ${post.comments.map(c => `<li>${c}</li>`).join('')}
        </ul>
        <input type="text" class="comment-input" placeholder="ÎåìÍ∏Ä ÏûëÏÑ±" />
        <button class="comment-btn">ÎåìÍ∏Ä Îì±Î°ù</button>
      </div>
    `;
    // Ï¢ãÏïÑÏöî Î≤ÑÌäº
    postDiv.querySelector('.like-btn').onclick = async () => {
      await fetch(`/api/posts/${post.id}/like`, { method: 'POST' });
      loadPosts(districtSelect.value);
    };
    // ÎåìÍ∏Ä Îì±Î°ù
    postDiv.querySelector('.comment-btn').onclick = async () => {
      const input = postDiv.querySelector('.comment-input');
      const comment = input.value.trim();
      if (comment) {
        await fetch(`/api/posts/${post.id}/comment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comment })
        });
        input.value = '';
        loadPosts(districtSelect.value);
      }
    };
    postsContainer.appendChild(postDiv);
  });
}

  function renderMiniNews(newsList) {
    const container = document.getElementById('mini-news-list');
    container.innerHTML = '';
    if (!newsList || newsList.length === 0) {
      container.innerHTML = '<div style="padding:16px; color:#888;">ÎåÄÏ†Ñ Í¥ÄÎ†® Ïã§ÏãúÍ∞Ñ Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
      return;
    }
    newsList.forEach(news => {
      const div = document.createElement('div');
      div.className = 'mini-news-item';
      div.style.display = 'flex';
      div.style.alignItems = 'center';
      div.style.gap = '10px';
      div.style.marginBottom = '10px';
      div.innerHTML = `<img src="${news.thumb}" style="width:28px; height:28px; border-radius:6px; object-fit:cover; box-shadow:0 1px 4px rgba(0,0,0,0.08);" alt="Ïç∏ÎÑ§Ïùº"> <a href="${news.link}" target="_blank" style="text-decoration:none;color:#222;font-weight:500;">${news.title}</a>`;
      container.appendChild(div);
    });
  }

  // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Îâ¥Ïä§ Î∂àÎü¨Ïò§Í∏∞
  window.addEventListener('DOMContentLoaded', fetchNews);

  // ÏïàÏ†Ñ Ï†úÎ≥¥ÌïòÍ∏∞ Î™®Îã¨ Ï†úÏñ¥
  window.addEventListener('DOMContentLoaded', () => {
    const reportBtn = document.getElementById('report-btn');
    const modal = document.getElementById('report-modal');
    const overlay = document.getElementById('report-modal-overlay');
    const closeBtn = document.getElementById('report-modal-close');
    const cancelBtn = document.getElementById('report-cancel');
    const photoArea = document.getElementById('report-photo-area');
    const photoInput = document.getElementById('report-photo');
    const photoLabel = document.getElementById('report-photo-label');

    function openModal() {
      modal.style.display = 'block';
      overlay.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      modal.style.display = 'none';
      overlay.style.display = 'none';
      document.body.style.overflow = '';
      photoInput.value = '';
      photoLabel.textContent = 'ÏÇ¨ÏßÑÏùÑ ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏóÖÎ°úÎìú';
    }
    if (reportBtn) reportBtn.addEventListener('click', openModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
    if (overlay) overlay.addEventListener('click', closeModal);

    // ÏÇ¨ÏßÑ Ï≤®Î∂Ä
    if (photoArea) {
      photoArea.addEventListener('click', () => photoInput && photoInput.click());
      photoArea.addEventListener('dragover', e => {
        e.preventDefault();
        photoArea.style.background = '#f5f5f5';
      });
      photoArea.addEventListener('dragleave', e => {
        e.preventDefault();
        photoArea.style.background = '';
      });
      photoArea.addEventListener('drop', e => {
        e.preventDefault();
        photoArea.style.background = '';
        if (photoInput && e.dataTransfer.files.length > 0) {
          photoInput.files = e.dataTransfer.files;
          if (photoLabel) photoLabel.textContent = e.dataTransfer.files[0].name;
        }
      });
    }
    if (photoInput) {
      photoInput.addEventListener('change', e => {
        if (photoInput.files.length > 0 && photoLabel) {
          photoLabel.textContent = photoInput.files[0].name;
        } else if (photoLabel) {
          photoLabel.textContent = 'ÏÇ¨ÏßÑÏùÑ ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏóÖÎ°úÎìú';
        }
      });
    }

    // Ï†úÎ≥¥ÌïòÍ∏∞ Î≤ÑÌäº (Ïã§Ï†ú ÏÑúÎ≤Ñ Ïó∞ÎèôÏùÄ ÎØ∏Íµ¨ÌòÑ, ÏïåÎ¶ºÎßå)
    var reportSubmitBtn = document.getElementById('report-submit');
    if (reportSubmitBtn) {
      reportSubmitBtn.addEventListener('click', () => {
        alert('Ï†úÎ≥¥Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§! (Îç∞Î™®)');
        closeModal();
      });
    }
  });

document.addEventListener('DOMContentLoaded', function() {
  // ...existing code for ÏßÄÎèÑ, Îâ¥Ïä§ Îì±...
  // ÏïàÏ†Ñ Ï†úÎ≥¥ÌïòÍ∏∞ Î≤ÑÌäº Î∞è Î™®Îã¨ ÎèôÏûëÏùÄ window.addEventListener('DOMContentLoaded', ...)ÏóêÏÑúÎßå Ï≤òÎ¶¨

  // ÏÇ¨ÏßÑ Ï≤®Î∂Ä Í∏∞Îä•
  if (imageDropZone && imageInput) {
    imageDropZone.onclick = function() {
      imageInput.click();
    };
    imageDropZone.ondragover = function(e) {
      e.preventDefault();
      imageDropZone.style.background = '#e0e7ff';
    };
    imageDropZone.ondragleave = function(e) {
      e.preventDefault();
      imageDropZone.style.background = '#fafafa';
    };
    imageDropZone.ondrop = function(e) {
      e.preventDefault();
      imageDropZone.style.background = '#fafafa';
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        imageInput.files = e.dataTransfer.files;
        handleImageUpload(e.dataTransfer.files[0]);
      }
    };
    imageInput.onchange = function(e) {
      if (e.target.files && e.target.files[0]) {
        handleImageUpload(e.target.files[0]);
      }
    };
  }

  // Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
  function handleImageUpload(file) {
    var reader = new FileReader();
    reader.onload = function(e) {
      previewImage.style.display = 'block';
      previewImage.innerHTML = '<img src="' + e.target.result + '" style="max-width:100%; max-height:80px; border-radius:8px;">';
      imageDropText.style.display = 'none';
    };
    reader.readAsDataURL(file);
  }

  // Ìèº Ï†úÏ∂ú
  if (reportForm) {
    reportForm.onsubmit = function(e) {
      e.preventDefault();
      var reportType = document.getElementById('reportType').value;
      var district = document.getElementById('district').value;
      var content = document.getElementById('content').value.trim();
      var imageData = '';
      if (imageInput && imageInput.files && imageInput.files[0]) {
        var reader = new FileReader();
        reader.onload = function(ev) {
          imageData = ev.target.result;
          saveReport(reportType, district, content, imageData);
        };
        reader.readAsDataURL(imageInput.files[0]);
      } else {
        saveReport(reportType, district, content, '');
      }
    };
  }

  // Ï†úÎ≥¥ Ï†ÄÏû• Ìï®Ïàò
  function saveReport(reportType, district, content, imageData) {
  if (!content || !reportType || !district) return;
  var reports = JSON.parse(localStorage.getItem('reports') || '[]');
  // Í≥†Ïú† id ÏÉùÏÑ± (timestamp + ÎûúÎç§)
  var uniqueId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
  reports.push({ id: uniqueId, reportType: reportType, district: district, content: content, imageData: imageData, date: new Date().toLocaleString() });
  localStorage.setItem('reports', JSON.stringify(reports));
  reportModal.style.display = 'none';
  reportForm.reset();
  previewImage.style.display = 'none';
  imageDropText.style.display = 'block';
  imageInput.value = '';
  alert('Ï†úÎ≥¥Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!');
  }
});

function renderTop5Risk() {
  var top5 = [
    { rank: 1, emoji: '‚ö†Ô∏è', area: 'ÏÑúÍµ¨ ÎëîÏÇ∞Îèô', type: 'ÍµêÌÜµ ÏúÑÌóò', count: 8 },
    { rank: 2, emoji: 'üè†', area: 'Ïú†ÏÑ±Íµ¨ Î¥âÎ™ÖÎèô', type: 'ÏãúÏÑ§ ÏúÑÌóò', count: 6 },
    { rank: 3, emoji: '‚ö†Ô∏è', area: 'ÎåÄÎçïÍµ¨ Ïã†ÌÉÑÏßÑÎèô', type: 'ÍµêÌÜµ ÏúÑÌóò', count: 5 },
    { rank: 4, emoji: 'üè†', area: 'ÏÑúÍµ¨ Í¥¥Ï†ïÎèô', type: 'ÏãúÏÑ§ ÏúÑÌóò', count: 4 },
    { rank: 5, emoji: 'üí†', area: 'Ï§ëÍµ¨ ÎåÄÏÇ¨Îèô', type: 'Í∏∞ÌÉÄ', count: 3 }
  ];
  var html = '<div class="card" style="border:1px solid #ffe066; border-radius:12px; padding:12px; margin-bottom:12px; background:#fffbe6;">';
  html += '<div style="font-weight:bold; color:#e89c1d; margin-bottom:6px; border-bottom:1px dashed #ffe066; padding-bottom:4px;">ÏúÑÌóòÏßÄÏó≠ <span style="color:#e89c1d;">TOP5</span></div>';
  html += '<ol style="padding-left:18px; margin:0;">';
  top5.forEach(function(item) {
    html += '<li style="margin-bottom:2px;">';
    html += '<span style="font-size:18px; vertical-align:middle;">' + item.emoji + '</span> ';
    html += '<span style="color:' + (item.rank === 1 ? '#e89c1d' : item.rank === 2 ? '#b8860b' : item.rank === 3 ? '#e89c1d' : item.rank === 4 ? '#b8860b' : '#1e90ff') + '; font-weight:' + (item.rank <= 3 ? 'bold' : 'normal') + ';">' + item.area + '</span> ';
    html += item.type + ' ' + item.count + 'Í±¥';
    html += '</li>';
  });
  html += '</ol></div>';
  var el = document.getElementById('top5RiskBox');
  if (el) el.innerHTML = html;
}



// Í∏∞Ï°¥ Ïã§ÏãúÍ∞Ñ Îâ¥Ïä§ ÏïåÎ¶º Î∞ïÏä§(mini-news-list)Ïóê Îâ¥Ïä§ Î†åÎçîÎßÅ
async function loadMiniNewsList() {
  try {
    const res = await fetch('/api/news');
    const newsList = await res.json();
    const container = document.getElementById('mini-news-list');
    if (!container) return;
    if (!newsList || newsList.length === 0) {
      container.innerHTML = '<div style="padding:16px; color:#888;">ÎåÄÏ†Ñ Í¥ÄÎ†® Ïã§ÏãúÍ∞Ñ Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
      return;
    }
    container.innerHTML = newsList.map(news =>
      `<div style="margin-bottom:18px;">
        <a href="${news.link}" target="_blank" style="font-weight:500;color:#1976d2;text-decoration:none;">${news.title}</a><br>
        <span style="font-size:0.95em;color:#888;">${news.pubDate}</span>
      </div>`
    ).join('');
  } catch (err) {
    if (document.getElementById('mini-news-list')) {
      document.getElementById('mini-news-list').innerHTML = '<div style="color:red;">Îâ¥Ïä§Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
    }
  }
}
window.addEventListener('DOMContentLoaded', loadMiniNewsList);
